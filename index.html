<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<link href="https://db.onlinewebfonts.com/c/e669dc3dfe6f38d646e8b58ea26c9672?family=Rogan+Light" rel="stylesheet" type="text/css"/>
		<link href="https://db.onlinewebfonts.com/c/a12d49b768b4bf1f6a0c26f90b552048?family=Rogan+SemiBold" rel="stylesheet" type="text/css"/>
		<link href="https://db.onlinewebfonts.com/c/bcd329db3107d78cc2e47e8077750927?family=Rogan-Regular" rel="stylesheet" type="text/css"/>
		<title>TESTING SVG</title>

		<style>
			body{
				font-family: "Rogan Regular";
			}
			
			#flex-main-container {
				display: flex;
				flex-direction: row;         /* left/right layout: SVG on left, order/cart on right */
				justify-content: flex-start; /* align items side by side */
				gap: 20px;                   /* spacing between svg and order/cart column */
			}

			#svgObj {
				flex: 2;            /* take up more space than order form and cart*/
				max-width: 60%;     /* keep svg from being too big */
				height:auto;
				flex-shrink: 1;		/* shrinks slower than order form*/
				flex-grow: 2;		/* grows faster than order form */
			}
			
			#flex-order-container {
				display: flex;
				flex-direction: column;   /* stack order form (and button) and cart vertically */
				gap: 20px;                /* spacing between table and cart */
				flex: 1;                     
				max-width: 40%;
			}

			#tableOut,
			#cart-container {
				width: 100%;               /* form table and cart full width */
				box-sizing: border-box;    /* so padding/border don't break alignment */
				flex-shrink: 2;			   /* shrinks faster than order form*/
				flex-grow: 1;			   /* grows faster than order form */
			}
			
			button {
				font-family: "Rogan Regular";
				font-size: 1.0em;
				cursor: pointer;
				background-color: #00205b;
				color: white;
				text-align: center;
				border-radius: 10px;
				border: 1px solid #0072ce;
				letter-spacing: 1px;
			}

			button:hover {
				background-color: #0072ce;
				border: 1px solid #00205b;
			}	

			/* styling for the cart - making individual parts indented underneath a parent part */
			.cart-groups { font: 14px/1.4 system-ui; }

			.cart-parent { margin: 12px 0 18px; }

			.cart-parent__title {
				font-family: "Rogan Regular";
				font-weight: 700; letter-spacing: .3px; margin-bottom: 6px;
				border-bottom: 1px solid #00205b; padding-bottom: 2px;
			}

			.cart-lines { 
				margin: 0; 
				padding-left: 16px; 
				list-style: none; 
				font-family: "Rogan Regular";
			}

			.cart-line { 
				display: grid; 
				grid-template-columns: 160px 2fr 50px; 
				gap: 12px; 
				padding: 4px 0; 
				align-items: center; 
			}

			.cart-line__part { font-weight: 600; }

			.cart-line__qty { 
				text-align: right; 
				white-space: nowrap; 
			}

		</style>
	</head>
	
	<body>
	  	<div id="stage">
			<!-- Input SN. Search txt doc if SN is valid and what SVG files are associated with it  -->
			<label for="sn-input">SN:</label>
			<input type="text" id="sn-input" />
			<button onclick="isValidSn()">Search</button>
			
			<div id="result" class="menu">
				<p>THIS IS WHERE FILE LIST WILL APPEAR</p>
			</div>

			<div id="flex-main-container">
				<!-- Display an initial SVG -->
				<object id= "svgObj" type="image/svg+xml">THIS IS WHERE THE SVG WILL APPEAR</object>

				<div id="flex-order-container"> 
					<!-- output for the 'ordering' table' -->
					<div id="order-form-container">
						<div id="tableOut"></div>
						<button id="btnAddToCart" onclick="table_to_cart()" style="display: none;">Add items to cart</button>
					</div>
					<div id="cart-container">
						<div id="cart"><p>THIS IS WHERE THE CART WILL APPEAR</p></div>
					</div>
				</div>
			</div>
	  	</div>


		
		<!------------------------------------------------ SCRIPTS ------------------------------------------------>

		<!-- script for checking JSON file and providing links to each part -->
		<script>
			async function isValidSn() 
			{
	      		const enteredSn = document.getElementById("sn-input").value.trim();
	      		const resultDiv = document.getElementById("result");
	
			  	try 
				{
			        // Load the JSON file
			        const response = await fetch("sn_docs.json");
			        const data = await response.json();
			
			        // Function to build links
			        const buildLinks = (files) => 
			          	files.map(file => `<a href="${file}" target="_blank">${file}</a>`).join("<br>");

					// Look for a system with a matching SN
    				const match = data.systems.find(system => system.sn === enteredSn);
					if (match) {
					  	resultDiv.innerHTML = "<strong>Files:</strong><br>" + buildLinks(match.files);
					} else {
					  	resultDiv.innerHTML = "No files found for SN: " + enteredSn;
					}
				} catch (error) {
					console.error("Error loading JSON:", error);
					resultDiv.innerHTML = "Error reading JSON file.";
				} 
			}
		</script>
		
		<!-- script to replace current SVG and to reproduce SVG table as a 'shopping form' to order parts -->
	   	<script>
			const obj = document.getElementById('svgObj');
			const out = document.getElementById('tableOut');

			// When clicking the navigation links, load the data into the 'svgObj' rather than opening a new tab
			document.querySelector('.menu').addEventListener('click', (e) => {
				const a = e.target.closest('a');
				if (!a) return;
				e.preventDefault();
				obj.data = a.getAttribute('href');
			});
		   
		  // When SVG loads into 'objSvg' check that the the content is valid svg file
			obj.addEventListener('load', () => {
				const svgDoc = obj.contentDocument || obj.getSVGDocument?.();
				if (svgDoc && svgDoc.documentElement?.tagName.toLowerCase() === 'svg') {
					handleSvgDoc(svgDoc);
				}
			});


			// extract each rows information useing the Line#
			function handleSvgDoc(svgDoc) {
				// Collect rows: all groups whose id starts with "Line"
				let groups = [...svgDoc.querySelectorAll('g[id^="Line"]')];
		
				// Put Line1, Line2, ... in order
				groups.sort((a, b) => (parseInt(a.id.match(/\d+/)) || 0) - (parseInt(b.id.match(/\d+/)) || 0));
			
				// Extract each cell text in order of appearance inside the group
				const rows = groups.map(g => [...g.querySelectorAll('text')].map(t => t.textContent.trim()));

				renderTable(rows);
		  	}

			// build HTML table using the rows of Line#
			function renderTable(rows) {
				const out = document.getElementById("tableOut");
				const btn = document.getElementById("btnAddToCart");
				if (!rows.length) {
					btn.style.display = "none";  // if no table then dont show button
					return;
				}

  				let html = '<table>';

				html += '<thead><tr><th>ITEM NO.</th><th>PART NUMBER</th><th>DESCRIPTION</th><th>QTY</th><th>ORDER QTY</th></tr></thead>';
				html += '<tbody>';
				for (const r of rows) {
					html += '<tr>'
						+ r.map(c => `<td>${escapeHtml(c)}</td>`).join('')
						+ `<td>
							<div class="qty-control">
								<button type="button" class="qty-btn" onclick="changeQty(this, -1)">-</button>
								<input type="number" step="1" min="0" value="0" size="4"/>
								<button type="button" class="qty-btn" onclick="changeQty(this, 1)">+</button>
							</div>
							</td>`
						+ '</tr>';
				}
				html += '</tbody></table>';
				out.innerHTML = html;
  				btn.style.display = "inline-block"; // button only showed when table/data has been rendered
			}

			// helper function to adjust qty input
			function changeQty(btn, delta) {
				const input = btn.parentElement.querySelector('input');
				let val = parseInt(input.value, 10) || 0;
				val += delta;
				if (val < 0) val = 0;
				input.value = val;
			}

			// convert svg tags to valid html tags
			function escapeHtml(s) {
				return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
			}
		</script>


		<!-- script to produce a cart which takes the items from the filled out form and saves them into local storage for persistency -->
		<script>
			let cart = JSON.parse(localStorage.getItem('cart')) || [];
			
			function saveCart() {
			  	localStorage.setItem('cart', JSON.stringify(cart));
			}

			function currentParentBaseFromObject() {
				try {
					const obj = document.getElementById('svgObj');
					const file = new URL(obj.data, window.location.href).pathname.split('/').pop();
					
					return file.replace(/\.svg$/i, '');		// strip ".svg"
				} catch {
					return '';
				}
			}

			
			function renderCart() {
				const el = document.getElementById('cart');
				if (!cart.length) { 
					el.innerHTML = "<p>Cart is empty.</p>"; return; 
				}

				// Group by parent ("" -> "(no parent)")
				const groups = new Map();
				for (const item of cart) {
					const key = (item.parent ?? '').trim();
					if (!groups.has(key)) groups.set(key, []);
					groups.get(key).push(item);
				}

				// sort parents and items
				const sortedParents = Array.from(groups.keys()).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
				let html = '<div class="cart-groups">';

				for (const parent of sortedParents) {
					const lines = groups.get(parent).slice()
					.sort((a,b) => a.part.localeCompare(b.part, undefined, {numeric:true}));

					html += `
					<div class="cart-parent">
						<div class="cart-parent__title">${parent || '(no parent)'}</div>
						<ul class="cart-lines">
						${lines.map(i => `
							<li class="cart-line">
							<span class="cart-line__part">${i.part}</span>
							<span class="cart-line__desc">${i.desc}</span>
							<span class="cart-line__qty">${i.qty}</span>
							<button type="button" class="cart-remove" title="Remove" onclick="removeCartItem('${escapeAttr(i.part)}','${escapeAttr(i.parent ?? '')}')"> X </button>
							</li>
						`).join('')}
						</ul>
					</div>`;
				}

				html += '</div>';
				el.innerHTML = html;
			}

			// helpers (safe for HTML/attributes)
			function escapeHtml(s) {
				return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
			}
			function escapeAttr(s) {
				return String(s).replace(/["'\\]/g, m => ({'"':'&quot;', "'":'&#39;', '\\':'\\\\'}[m]));
			}
			

			function removeCartItem(part, parent) {
				const key = `${part}::${parent || ''}`;
				const idx = cart.findIndex(i => `${i.part}::${i.parent || ''}` === key);
				if (idx !== -1) {
					cart.splice(idx, 1);
					saveCart();
					renderCart();
				}
			}

			
			
			function table_to_cart() {
				const rows = document.querySelectorAll('#tableOut table tbody tr');
				const parent = currentParentBaseFromObject();

				rows.forEach(tr => {
					const cells = tr.querySelectorAll('td');
					const qtyInput = tr.querySelector('input');
					if (!qtyInput) return;

					const qty = parseInt(qtyInput.value, 10) || 0;
					if (qty <= 0) return;

					const item = {
					part:   (cells[1]?.textContent || '').trim(), // PART NUMBER
					desc:   (cells[2]?.textContent || '').trim(), // DESCRIPTION
					parent,                                       // <- from current SVG
					qty
					};

					const key = `${item.part}::${item.parent}`;
					const existing = cart.find(i => `${i.part}::${i.parent}` === key);
					if (existing) existing.qty += qty;
					else cart.push(item);
				});

				saveCart();
				renderCart();
			}


			// extract the rows from the cart for odoo to be able to access the cart data
			function readCartFromTable() {
				const table = document.getElementById("cartTable");
				if (!table) return [];
				const rows = [];
				table.querySelectorAll("tbody tr").forEach(tr => {
					const tds = tr.querySelectorAll("td");
					if (tds.length >= 4) {
						rows.push({
							part:        tds[0].textContent.trim(),
							description: tds[1].textContent.trim(),
							parent:      tds[2].textContent.trim(),
							qty:         parseInt(tds[3].textContent.trim(), 10) || 0
						});
					}
				});
				return rows;
			}

			
			// Listen for parent requests. Allows Odoo to get the cart stored in Github, and also clear the cart info from Githubs storage
			window.addEventListener("message", e => {
				if (e.data && e.data.type === "REQUEST_CART_ROWS") {
					const rows = readCartFromTable();
					e.source.postMessage({ type: "CART_ROWS", rows }, e.origin);
			  	}
				if (data.type === "CLEAR_CART") {
					try {
						localStorage.removeItem("cart");       // clear storage
						
						// re-render the cart UI on the child so it shows "empty"
						if (typeof renderCart === "function") renderCart();
					} finally {
						e.source.postMessage({ type: "CART_CLEARED" }, e.origin);
					}
				}
			});
	  </script>
	</body>
</html>
