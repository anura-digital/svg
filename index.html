<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<link href="https://db.onlinewebfonts.com/c/e669dc3dfe6f38d646e8b58ea26c9672?family=Rogan+Light" rel="stylesheet" type="text/css"/>
		<link href="https://db.onlinewebfonts.com/c/a12d49b768b4bf1f6a0c26f90b552048?family=Rogan+SemiBold" rel="stylesheet" type="text/css"/>
		<link href="https://db.onlinewebfonts.com/c/bcd329db3107d78cc2e47e8077750927?family=Rogan-Regular" rel="stylesheet" type="text/css"/>
		<title>TESTING SVG</title>

		<style>
			body{
				font-family: "Rogan Regular";
			}
			
			#flex-main-container {
				display: flex;
				flex-direction: row;         /* left/right layout: SVG on left, order/cart on right */
				justify-content: flex-start; /* align items side by side */
				gap: 20px;                    /* spacing between svg and order/cart column */
				align-items: flex-start;
			}

			#svgObj {
				flex: 3;            /* take up more space than order form and cart*/
				max-width: 70%;     /* keep svg from being too big */
				height:auto;
				flex-shrink: 1;		/* shrinks slower than order form*/
				flex-grow: 3;		/* grows faster than order form */
			}
			
			#flex-order-container {
				display: flex;
				flex-direction: column;   /* stack order form (and button) and cart vertically */
				gap: 20px;                /* spacing between table and cart */
				flex: 1;                     
				max-width: 30%;
			}

			#tableOut,
			#cart-container {
				width: 100%;               /* form table and cart full width */
				box-sizing: border-box;    /* so padding/border don't break alignment */
				flex-shrink: 2;			   /* shrinks faster than order form*/
				flex-grow: 1;			   /* grows faster than order form */
			}

			/* light blue grid, column size adjust, no left or right borders on first and last column */
			#tableOut table {
				border-collapse: collapse;
				border-spacing: 0;
				margin-bottom: 10px;
			}

			#tableOut th,
			#tableOut td {
				border: 1px solid #00205b;
				padding: 5px;
				margin: 0;
			}
			#tableOut th:first-child,
			#tableOut td:first-child {
				border-left: none;
				width: 150px;
			}
			
			#tableOut th:last-child,
			#tableOut td:last-child {
				border-right: none;
			}

			
			#tableOut td:nth-child(2), 
			#tableOut th:nth-child(2) {
			  width: 150px;  			/* PART NUMBER column */
			}
			
			#tableOut td:nth-child(3), 
			#tableOut th:nth-child(3) {
			  width: 300px;  			/* DESCRIPTION column */
			}
			
			#tableOut td:nth-child(5), 
			#tableOut th:nth-child(5) {
			  width: 180px;  			/* ORDER QTY column */
			}
			
			
			button {
				font-family: "Rogan Regular";
				font-size: 1.0em;
				cursor: pointer;
				background-color: #00205b;
				color: white;
				text-align: center;
				border-radius: 10px;
				border: 1px solid #0072ce;
				letter-spacing: 1px;
			}

			button:hover {
				background-color: #0072ce;
				border: 1px solid #00205b;
			}	

			/* styling for the cart - making individual parts indented underneath a parent part */
			.cart-groups { font: 14px/1.4 system-ui; }

			.cart-parent { margin: 12px 0 18px; }

			.cart-parent__title {
				font-family: "Rogan Regular";
				font-weight: 700; letter-spacing: .3px; margin-bottom: 6px;
				border-bottom: 1px solid #00205b; padding-bottom: 2px;
			}

			.cart-lines { 
				margin: 0; 
				padding-left: 16px; 
				list-style: none; 
				font-family: "Rogan Regular";
			}

			.cart-line { 
				display: grid; 
				grid-template-columns: 160px 2fr 50px; 
				gap: 12px; 
				padding: 4px 0; 
				align-items: center; 
			}

			.cart-line__part { font-weight: 600; }

			.cart-line__qty { 
				text-align: right; 
				white-space: nowrap; 
			}

			/* styling for the add and minus buttons in the form */
			.qty-control {
				display: grid;
				grid-template-columns: 30px 1fr 30px; /* left button, input, right button */
				align-items: center;
				gap: 4px;
				max-width: 120px;  /* keep the whole control compact */
			}
				
			.qty-control input {
			   text-align: center;
			   width: 100%;       /* input expands in middle column */
			   min-width: 40px;
			   box-sizing: border-box;
			}
				
			.qty-btn {
			   display: flex;
			   align-items: center;
			   justify-content: center;
			   cursor: pointer;
			}

			/* indent all but the first link in file tree (creates a 'parent file with sub files' look) */
			.file-tree {
			  margin-left: 20px;
			}
			.file-tree:first-of-type {
			  margin-left: 0;
			}

			/* styling for the popup cart modal */
			.modal {
			  display: none; /* Hidden by default */
			  position: fixed; /* Stay in place */
			  z-index: 1; /* Sit on top */
			  left: 0;
			  top: 0;
			  width: 100%; /* Full width */
			  height: 100%; /* Full height */
			  overflow: auto; /* Enable scroll if needed */
			  background-color: rgb(0,0,0); /* Fallback color */
			  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
			}

			#modal-cart-container {
			  background-color: #fefefe;
			  margin: 15% auto; /* 15% from the top and centered */
			  padding: 20px;
			  border: 1px solid #888;
			  width: 80%; /* Could be more or less, depending on screen size */
			  position: relative;
			}

			#close {
			  float: right;
			  color: #aaa;
			  font-size: 28px;
			  font-weight: bold;
			}
			
			#close:hover,
			#close:focus {
			  color: black;
			  text-decoration: none;
			  cursor: pointer;
			}
		</style>
	</head>
	
	<body>
	  	<div id="stage">
			<!-- Input SN. Search txt doc if SN is valid and what SVG files are associated with it  -->
			<label for="sn-input">SN:</label>
			<input type="text" id="sn-input" />
			<button onclick="isValidSn()">Search</button>

			<!-- Button to show the cart popup -->
			<button id="open-cart">CLICK TO OPEN CART</button>

			<!-- shows the file links -->
			<div id="result" class="menu">
				<p>THIS IS WHERE FILE LIST WILL APPEAR</p>
			</div>

			<div id="flex-main-container">
				<object id= "svgObj" type="image/svg+xml">THIS IS WHERE THE SVG WILL APPEAR</object>

				<div id="flex-order-container"> 
					<!-- Pop up modal to show the cart, rather than being below the order form -->
					<div id="myModal" class="modal">
						<div id="modal-cart-container">
							<span id="close"> &times; </span>
							<div id="modal-cart"></div>
							<button id="clear-button" onclick="clearCart()" style="display: none;"> CLEAR CART </button>	
						</div>
					</div>
					
					<!-- output for the 'ordering' table' -->
					<div id="order-form-container">
						<div id="tableOut"></div>
						<button id="btnAddToCart" onclick="table_to_cart()" style="display: none;">Add items to cart</button>
					</div>
					
					<!-- output for the first version of cart -->
					<div id="cart-container">
						<div id="cart"><p>THIS IS WHERE THE CART WILL APPEAR</p></div>
						<button id="clear-button" onclick="clearCart()" style="display: none;"> CLEAR CART </button>	
					</div>
				</div>
			</div>
			<button onclick="getStorage()">testing storage retrieval</button>
	  	</div>


		
		<!------------------------------------------------ SCRIPTS ------------------------------------------------>
		<!-- TESTING FUNCTION TO SHOW WHAT IS STORED IN THE LOCAL STORAGE -->
		<script>
			function getStorage() {
				var cart = localStorage.getItem("cart");
				console.log(cart);
			}
		</script>

		<script>
			document.addEventListener("DOMContentLoaded", function() {
			  renderCart();
			});
		</script>

		<!-- cart popup functionality - TESTING -->
		<script>
			// Get the modal
			var modal = document.getElementById("myModal");
			
			// button that opens the modal
			var btn = document.getElementById("open-cart");
			
			// Get the close modal <span>
			var span = document.getElementById("close");
			
			// When the user clicks on the button, open the modal
			btn.onclick = function() {
			  modal.style.display = "block";
			}
			
			// When the user clicks on <span> (x), close the modal
			span.onclick = function() {
			  modal.style.display = "none";
			}
			
			// When the user clicks anywhere outside of the modal, close it
			window.onclick = function(event) {
			  if (event.target == modal) {
			    modal.style.display = "none";
			  }
			}
		</script>

					
		<!----------------------------- get SN's files from JSON and provide links to each part ----------------------------->
		<script>
			async function isValidSn() 
			{
	      		const enteredSn = document.getElementById("sn-input").value.trim();
	      		const resultDiv = document.getElementById("result");
	
			  	try 
				{
			        // Load the JSON file
			        const response = await fetch("sn_docs.json");
			        const data = await response.json();
			
			        // Function to build links
			        const buildLinks = (files) => 
						files.map(file => `<div class="file-tree"><a href="${file}" target="_blank">${file}</a></div>`).join("");
					
					// Look for a system with a matching SN
    				const match = data.systems.find(system => system.sn === enteredSn);
					if (match) {
					  	resultDiv.innerHTML = "<strong>Files:</strong><br>" + buildLinks(match.files);
					} else {
					  	resultDiv.innerHTML = "No files found for SN: " + enteredSn;
					}
				} catch (error) {
					console.error("Error loading JSON:", error);
					resultDiv.innerHTML = "Error reading JSON file.";
				} 
			}
		</script>
		
		<!----------------------------- replace current SVG and reproduce SVG table as a 'shopping form' to order parts ----------------------------->
	   	<script>
			const obj = document.getElementById('svgObj');
			const out = document.getElementById('tableOut');

			// When clicking the navigation links, load the data into the 'svgObj' rather than opening a new tab
			document.querySelector('.menu').addEventListener('click', (e) => {
				const a = e.target.closest('a');
				if (!a) return;
				e.preventDefault();
				obj.data = a.getAttribute('href');
			});
		   
		  // When SVG loads into 'objSvg' check that the the content is valid svg file
			obj.addEventListener('load', () => {
				const svgDoc = obj.contentDocument || obj.getSVGDocument?.();
				if (svgDoc && svgDoc.documentElement?.tagName.toLowerCase() === 'svg') {
					handleSvgDoc(svgDoc);
				}
			});


			// extract each rows information useing the Line#
			function handleSvgDoc(svgDoc) {
				// Collect rows: all groups whose id starts with "Line"
				let groups = [...svgDoc.querySelectorAll('g[id^="Line"]')];
		
				// Put Line1, Line2, ... in order
				groups.sort((a, b) => (parseInt(a.id.match(/\d+/)) || 0) - (parseInt(b.id.match(/\d+/)) || 0));
			
				// Extract each cell text in order of appearance inside the group
				const rows = groups.map(g => [...g.querySelectorAll('text')].map(t => t.textContent.trim()));

				renderTable(rows);
		  	}

			// build HTML table using the rows of Line#
			function renderTable(rows) {
				const out = document.getElementById("tableOut");
				const btn = document.getElementById("btnAddToCart");
				const clearbtn = document.getElementById("clear-button");
				if (!rows.length) {
					btn.style.display = "none";  // if no table then dont show buttons
					clearbtn.style.display = "none";
					return;
				}

  				let html = '<table>';
				html += '<thead><tr><th>ITEM NO.</th><th>PART NO.</th><th>DESCRIPTION</th><th>QTY</th><th>ORDER QTY</th></tr></thead>';
				html += '<tbody>';
				for (const r of rows) {
					html += '<tr>'
						+ r.map(c => `<td>${escapeHtml(c)}</td>`).join('')
						+ `<td>
							<div class="qty-control">
								<button type="button" class="qty-btn" onclick="changeQty(this, -1)">-</button>
								<input type="number" step="1" min="0" value="0" size="4"/>
								<button type="button" class="qty-btn" onclick="changeQty(this, 1)">+</button>
							</div>
							</td>`
						+ '</tr>';
				}
				html += '</tbody></table>';
				out.innerHTML = html;
  				btn.style.display = "inline-block"; 	// buttons only showed when table/data has been rendered
				clearbtn.style.display = "inline-block";
			}

			// adjust the quantity of item by +1 / -1
			function changeQty(btn, delta) {
				const input = btn.parentElement.querySelector('input');
				let val = parseInt(input.value, 10) || 0;
				val += delta;
				if (val < 0) val = 0;	// prevents user from entering a 0 qty in the order form
				input.value = val;
			}

			// convert svg tags to valid html tags
			function escapeHtml(s) {
				return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
			}
		</script>


		<!----------------------------- produce cart with items from the order form, saves to local storage ----------------------------->
		<script>
			let cart = JSON.parse(localStorage.getItem('cart')) || [];

			// save the cart to local Storage
			function saveCart() {
			  	localStorage.setItem('cart', JSON.stringify(cart));

				if (window.parent) {
				    window.parent.postMessage(
				      { type: "CART_UPDATED", cart: JSON.stringify(cart) },
				      "https://anuranz.odoo.com/"
				    );
				  }
			}

			// for each 'sub part' extract the parent part using the filename. Helps identify what schematic an item comes from.
			function currentParentBaseFromObject() {
				const obj = document.getElementById('svgObj');
				
				try {
					const url = obj.contentDocument.URL;
					const filename = url.split("/").pop();
					var filenameStripped = "";
					
					// Remove the ".svg" from the filename
					if (filename.toLowerCase().endsWith(".svg")) {
						  filenameStripped = filename.replace(/\.svg$/i, '');
						  console.log(filenameStripped);
					}
					return filenameStripped;
				} catch { 
					console.log("running the catch block");
					return '';
				}
			}

			// display the stored information in an HTML table
			function renderCart() {
				const el = document.getElementById('cart');
				const cartModal = document.getElementById('modal-cart');
				const clearBtn = document.getElementById('clear-button');

				if (!el || !cartModal) return; // added for sync between two different carts

				
				if (!cart.length) { 
					//el.innerHTML = "<p>Cart is empty.</p>"; return; 
					//cartModal.innerHTML = "<p>Modal cart is empty</p>"; return;
					const emptyHtml = "<p>Cart is empty.</p>";
				    el.innerHTML = emptyHtml;
				    cartModal.innerHTML = emptyHtml;               // update modal too
				    if (clearBtn) clearBtn.style.display = 'none'; // hide clear when empty
				    return;
				}

				// Group by parent part (puts all subparts together under a parent part)
				const groups = new Map();
				for (const item of cart) {
					const key = (item.parent ?? '').trim();
					if (!groups.has(key)) groups.set(key, []);
					groups.get(key).push(item);
				}

				// sort parents and items
				const sortedParents = Array.from(groups.keys()).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
				let html = '<div class="cart-groups">';

				for (const parent of sortedParents) {
					const lines = groups.get(parent).slice()
					.sort((a,b) => a.part.localeCompare(b.part, undefined, {numeric:true}));

					html += `
					<div class="cart-parent">
						<div class="cart-parent__title">${parent || '(no parent)'}</div>
						<ul class="cart-lines">
						${lines.map(i => `
							<li class="cart-line">
								<span class="cart-line__part">${i.part}</span>
								<span class="cart-line__desc">${i.desc}</span>
								<span class="cart-line__qty">${i.qty}</span>
		   						<button type="button" class="qty-btn" onclick="updateQty(this, -1)"> - </button>
			  					<button type="button" class="qty-btn" onclick="updateQty(this, 1)"> + </button>
								<button type="button" class="cart-remove" title="Remove" onclick="removeCartItem('${escapeAttr(i.part)}','${escapeAttr(i.parent ?? '')}')"> X </button>
							</li>
						`).join('')}
						</ul>
					</div>`;
				}

				html += '</div>';
				el.innerHTML = html;
				cartModal.innerHTML = html;
			}

			// helpers (safe for HTML/attributes)
			function escapeHtml(s) {
				return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
			}
			function escapeAttr(s) {
				return String(s).replace(/["'\\]/g, m => ({'"':'&quot;', "'":'&#39;', '\\':'\\\\'}[m]));
			}

			// update the cart quantities by +1 / -1
			function updateQty(btn, delta) {

				// get the correct line/item to adjust quantities
				const line = btn.closest(".cart-line");
				if (!line) return;

				// get the qty column (identify using the <span>)
				const qtyCol = line.querySelector(".cart-line__qty");
				if (!qtyCol) return;
				
				// adjust qty in DOM
				let qty = parseInt(qtyCol.textContent, 10) || 0;
				qty = Math.max(1, qty + delta);						// changed to a 1 as dont want user to have a 0 qty in the cart (???) - should use the remove item button
				qtyCol.textContent = qty;
				
				// identify the item (by part + parent)
				const part = line.querySelector(".cart-line__part")?.textContent;
				const parent = line.closest(".cart-parent")
				   ?.querySelector(".cart-parent__title")?.textContent;
				
				// update cart array
				let item = cart.find(i => i.part === part && i.parent === parent);
				if (item) {
				   item.qty = qty;
				} else {
				   // if not found add it (shouldnt happen, but safety check)
				   cart.push({ part, parent, qty });
				}
				
				// save
				saveCart();
				renderCart();
			}


			// delete an item from cart. Need to update the storage and re-render the cart to show update.
			function removeCartItem(part, parent) {
				const key = `${part}::${parent || ''}`;
				const idx = cart.findIndex(i => `${i.part}::${i.parent || ''}` === key);
				if (idx !== -1) {
					cart.splice(idx, 1);
					saveCart();
					renderCart();
				}
			}

			function clearCart() {
				cart = [];		// set cart to empty list, then save into local storage
				saveCart();
				renderCart();
			}

			// extract all the items from the order form that have a qty > 0
			function table_to_cart() {
				const rows = document.querySelectorAll('#tableOut table tbody tr');
				const parent = currentParentBaseFromObject();

				rows.forEach(tr => {
					const cells = tr.querySelectorAll('td');
					const qtyInput = tr.querySelector('input');
					if (!qtyInput) return;

					const qty = parseInt(qtyInput.value, 10) || 0;
					if (qty <= 0) return;

					const item = {
					part:   (cells[1]?.textContent || '').trim(), // PART NUMBER
					desc:   (cells[2]?.textContent || '').trim(), // DESCRIPTION
					parent,                                       // <- from current SVG
					qty
					};

					const key = `${item.part}::${item.parent}`;
					const existing = cart.find(i => `${i.part}::${i.parent}` === key);
					if (existing) existing.qty += qty;
					else cart.push(item);

					// reset the qty to 0 of curr form (no persistency for other forms)
					qtyInput.value = 0;
				});

				saveCart();
				renderCart();
			}
	  </script>

	  <!------------------------------- Allows Odoo to get the iframes data from local storage (odoo and iframe in same page but different storages) ------------------------------->
	  <script>
		(function () {
		  const PARENT_ORIGIN = "https://anuranz.odoo.com/";
		
		  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
		
		  function send(type) {
		    if (window.parent) {
		      window.parent.postMessage({ type, cart: JSON.stringify(cart) }, PARENT_ORIGIN);
		    }
		  }
		
		  function saveCart() {
		    localStorage.setItem("cart", JSON.stringify(cart));
		    send("CART_UPDATED");
		  }
		
		  // auto notify whenever someone sets 'cart' in localStorage
		  const _setItem = localStorage.setItem.bind(localStorage);
		  localStorage.setItem = function (k, v) {
		    _setItem(k, v);
		    if (k === "cart") {
		      try { cart = JSON.parse(v || "[]"); } catch { cart = []; }
		      send("CART_UPDATED");
		    }
		  };
		
		  // Answer parent requests
		  window.addEventListener("message", (event) => {
		    if (event.origin !== PARENT_ORIGIN) return;
		    
			const data = event.data || {};
		    if (data.type === "GET_CART") {
		      event.source?.postMessage({ type: "CART_VALUE", cart: JSON.stringify(cart) }, event.origin);
		    } else if (data.type === "SET_CART") {
		      try { cart = data.cart ? JSON.parse(data.cart) : []; } catch { cart = []; }
		      saveCart();
		    } else if (data.type == "SN_VALUE") {
				var sn = document.getElementById("sn-input").value;
				event.source?.postMessage({type: "SN_VALUE", sn}, event.origin);
			}
		  });
		
		  // let Odoo page know are ready (may not need)
		  send("IFRAME_READY");
		})();
	</script>


	</body>
</html>





